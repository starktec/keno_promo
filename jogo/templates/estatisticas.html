{% extends "nav-bar.html" %}
{% block titulo %}
ESTATÍSTICAS
{% endblock %}
{% block nav-bar %}

<div class="row">
    <div class="col-lg-12">
        <div class="card crud-bar">
            <div class="row justify-content-center align-items-center form-group">
                <form action="/estatisticas/" method="post" class="col-xs-12 col-sm-12 col-md-12 col-xl-12 row justify-content-start" id="form1" name="form1">
                {% csrf_token %}
                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 container-input-create-secundary">
                        <div class="form-group">
                            <div class="form-control-wrap">
                                <div class="form-icon icon-calendar form-icon-right">
                                    <em class="icon ni ni-calendar-alt"></em>
                                </div>
                                {{ form.data_inicio }}
                                <label class="form-label-outlined label-search" for="id_data_inicio">Data inicio/Dia</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 container-input-create-secundary">
                        <div class="form-group">
                            <div class="form-control-wrap">
                                <div class="form-icon icon-calendar form-icon-right">
                                    <em class="icon ni ni-calendar-alt"></em>
                                </div>
                                {{ form.data_fim }}
                                <label class="form-label-outlined label-search" for="id_data_fim">Data Fim</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 container-input-create-secundary">
                        <div class="form-group">
                            <div class="form-control-wrap">
                                {{ form.sorteio }}
                                <label class="form-label-outlined" for="id_sorteio">Sorteio</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 container-input-create-secundary">
                        <div class="form-group">
                            <div class="form-control-wrap">
                                {{ form.estabelecimento }}
                                <label class="form-label-outlined" for="id_estabelecimento">Estabelecimento</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 container-input-create-secundary">
                        <div class="form-group">
                            <div class="form-control-wrap">
                                {{ form.agrupar_por }}
                                <label class="form-label-outlined" for="id_agrupar_por">Agrupar</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-2 col-md-2 col-lg-1 col-xl-1 container-input-search text-right form-group input-margin-top">
                        <button class="col-3 col-sm-12 col-md-12 col-lg-12 col-xl-12 justify-content-center btn btn-success btn-search form-control-lg">
                            <em class="icon ni ni-search"></em>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>    
<div class="row my-row">
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Sorteios</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ qtd_partidas }}</h6>
                </div>
            </div>
        </div>
        {% if filtro  and not agrupar %}
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Aderência</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_aderencia }}%</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Efetividade</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_efetividade }}%</h6>
                </div>
            </div>
        </div>
        {% elif agrupar%}
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Total Bilhetes</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ total_bilhetes }}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Bilhetes</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_bilhetes }}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Total Cartelas</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ total_cartelas }}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Cartelas</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_cartelas }}</h6>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Aderência</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_aderencia }}/{{todas_as_telas}}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Efetividade</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_efetividade }}/{{pdvs_total}}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Bilhetes</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_bilhetes }}</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card cards-status">
                <div class="row text-center">
                    <em class="icon ni ni-trend-up icon-card color-card-pos"></em>
                    <h6 class="title-card color-card-pos">Média Cartelas</h6>
                </div>
                <div class="row">
                    <h6 class="col-12 text-right subtitle-card">{{ media_cartelas }}</h6>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
<div class="row my-row">
    <div class="col-12">
        <div class="card table-responsive-lg overflow-auto">
        {% if not agrupar %}
            <table class="table position-relative table-content table-hover">
                <thead class="thead-dark text-center thead-content" >
                    <tr>
                        <th></th>
                        <th>Sorteio</th>
                        <th>Aderencia</th>
                        <th>Efetividade</th>
                        <th>Bilhetes Vendidos</th>
                        <th>Cartelas Vendidas</th>
                    </tr>
                </thead>

                <tbody class="text-center tbody-content">
                {% for p,qtd_bilhetes,qtd_cartelas,pdvs,baixaram,venderam in partidas %}
                    <tr data-toggle="collapse" data-target="#partida{{p.id}}" class="accordion-toggle">
                        <td></td>
                        <td>{{p}}</td>
                        <td>{{baixaram}}/{{todos_estabelecimentos}}</td>
                        <td>{{venderam}}/{{pdvs_total}}</td>
                        <th>{{qtd_bilhetes}}</th>
                        <th>{{qtd_cartelas}}</th>
                    </tr>
                    <tr>
                        <td colspan="12" class="hiddenRow">
                            <div class="accordian-body collapse" id="partida{{p.id}}"> 
                                <table id="p{{p.id}}" class="table table-striped">
                                        <thead class="thead-dark text-center thead-content">
                                            <tr class="info">
                                                <th>Estabelecimento</th>
                                                <th>Recebeu Sorteio</th>
                                                <th>Bilhetes</th>
                                                <th></th>
                                                <th>Cartelas</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                    <tbody>
                                    {% for p,tela,qtd,porcentagem,qtd1,porcentagem1 in pdvs%}
                                        <tr>
                                            <td>{{p}}</td>
                                            {% if tela %}
                                            <td>Sim</td>
                                            {%else%}
                                            <td>Não</td>
                                            {%endif%}
                                            <td>{{qtd}} ({{porcentagem}}%)</td>
                                            <td></td>
                                            <td>{{qtd1}} ({{porcentagem1}}%)</td>
                                            <td></td>
                                        </tr>  
                                    {% endfor %}                                                                                                             
                                    </tbody>
                                </table>             
                            </div> 
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <table id="agrupado_por" class="table position-relative table-content table-hover">
                <thead class="thead-dark text-center thead-content" >
                    <tr>
                        <th></th>
                        <th>Estabelecimento</th>
                        <th>Bilhetes Vendidos</th>
                        <th>%</th>
                        <th>Cartelas Vendidas</th>
                        <th>%</th>
                        <th>Aderencia</th>
                        <th>%</th>
                        <th>Efetividade</th>
                        <th>%</th>
                    </tr>
                </thead>

                <tbody class="text-center tbody-content">
                {% for p,qtd_bilhetes,porcentagem_bilhetes,qtd_cartelas,porcentagem_cartelas,aderencia,aderencia_porcentagem,efetividade,efetividade_porcentagem in estabelecimentos %}
                    <tr data-toggle="collapse" data-target="#partida{{p.id}}" class="accordion-toggle">
                        <td></td>
                        <td>{{p}}</td>
                        <th>{{qtd_bilhetes}}</th>
                        <th>{{porcentagem_bilhetes}}</th>
                        <th>{{qtd_cartelas}}</th>
                        <th>{{porcentagem_cartelas}}</th>
                        <th>{{aderencia}}/{{qtd_partidas}}</th>
                        <th>{{aderencia_porcentagem}}</th>
                        <th>{{efetividade}}/{{qtd_partidas}}</th>
                        <th>{{efetividade_porcentagem}}</th>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
        </div>
    </div>
</div>
{% if qtd_partidas > 0 %}
<div class="row my-row pagination-container">
    <div class="col-12 row justify-content-center">
        <nav aria-label="Navegação de página exemplo">
            <ul class="pagination">
                {% if pagina_anterior > 0 %}
                <li class="pageitem button-paginação">
                    <button class="page-link button-paginação" aria-hidden="true" onclick=test(1)>&laquo;</button>
                </li> 
                <li class="page-item button-paginação">
                    <button class="page-link button-paginação" class="sr-only" onclick=test({{pagina_anterior}})>
                        &lt;
                    </button>
                </li>
                {%endif%}  
                <li class="page-item button-paginação">
                    <a class="page-link button-paginação">{{ pagina }}</a>
                </li>
                {% if ultima_pagina != pagina %}
                <li class="page-item button-paginação">
                    <button class="page-link button-paginação" class="sr-only" onclick=test({{proxima_pagina}})>
                        &gt;
                    </button>
                </li>  
                <li class="page-item button-paginação">
                    <button class="page-link button-paginação" aria-hidden="true" onclick=test({{ultima_pagina}})>&raquo;</button>
                </li>
                {%endif%}
            </ul>
        </nav>
    </div>
</div>
{% endif %}
<script>
    $(document).ready( function () {
        $('#agrupado_por').DataTable({
            "language": {
                "url":"https://cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json",
            },
            "dom": '',
            columnDefs: [
            { orderable: false, targets: [0,6,8] }
            ], 
            paging: false,
            "order": [[ 1, "desc" ]],
        });
    } );
    let clickado = false
    function test(pagina){
        if(clickado == false){
            $('#form1').attr('action', $('#form1').attr('action') +'?pagina='+parseInt(pagina));
            $('#form1').submit();   
            clickado = true
        }
    }
    $(function () {
        let estabelecimento = $('#id_estabelecimento');
        let agrupar = $('#id_agrupar_por');
        let data_fim = $('#id_data_fim');
        let sorteio = $('#id_sorteio');
        if (estabelecimento.val() == '' && agrupar.val() != 'estabelecimento') {
            data_fim.prop('disabled',true);
            sorteio.prop('disabled',false);
        }
        else{
            data_fim.prop('disabled',false);
            sorteio.prop('disabled',true);
        }
    })
    $( "#id_estabelecimento" ).change(function() {
        let estabelecimento = $('#id_estabelecimento');
        let data_fim = $('#id_data_fim');
        let agrupar = $('#id_agrupar_por')
        if (estabelecimento.val() == '' && agrupar.val() != 'estabelecimento') {
            data_fim.prop('disabled',true);
        }
        else{
            data_fim.prop('disabled',false);
        }
    });
    $( "#id_agrupar_por" ).change(function() {
        let estabelecimento = $('#id_estabelecimento');
        let agrupar = $('#id_agrupar_por');
        let data_fim = $('#id_data_fim');
        let sorteio = $('#id_sorteio');
        if (estabelecimento.val() == '' && agrupar.val() != 'estabelecimento') {
            data_fim.prop('disabled',true);
            sorteio.prop('disabled',false);
        }
        else{
            data_fim.prop('disabled',false);
            sorteio.prop('disabled',true);
        }
    });

    
</script>

<style>
    .table-hover:hover{
    cursor:pointer;
    }
</style>


{% endblock %}